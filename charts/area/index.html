<!DOCTYPE html>
<title>Area Chart</title>
<meta charset="utf-8" />
<style>
  body,
  html {
    overflow: hidden;
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
  }
  .chart-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
  }
</style>
<div id="chart-wrapper" class="chart-wrapper"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.3.0/echarts.min.js"></script>
<script src="https://d3js.org/d3-collection.v1.min.js"></script>
<!-- d3 script for csv -->
<script src="https://d3js.org/d3.v4.js"></script>
<script>
  let state = "notLoaded";
  let datasetUrl = "";
  let source;
  let data;
  let cols;
  let width;
  let height;
  let config = {};
  let option = {};
  let col_rel = {};
  let chartDom;
  let chart;
  let isChartInitialized = false;
  // todo
  let develop = false;
  let showLegend = true;

  const onWindowResize = () => {
    width = document.documentElement.scrollWidth;
    height = document.documentElement.scrollHeight;
    if (chart)
      chart.resize({
        width: width,
        height: height,
      });
  };

  window.addEventListener("resize", onWindowResize);

  function onMessage(event) {
    if (typeof event?.data == "object") {
      return;
    }
    const allowedOrigins = [
      "http://127.0.0.1:5500",
      "http://localhost:5500",
      "http://127.0.0.1:3000",
      "http://localhost:3000",
      "https://cafedata.io",
      "*",
    ];
    if (!allowedOrigins.includes(event.origin)) {
      console.error(`Invalid origin: ${event.origin}`);
      return;
    }
    try {
      const request = JSON.parse(event.data);
      switch (request.command) {
        case "config_changed":
          update_config_handler(request.config);
          break;
        case "columns_relation_changed":
          col_rel = request.columns_relation;
          if (isChartInitialized) {
            change_col(col_rel);
          }
          break;
        case "data_changed":
          datasetUrl = request.data;
          chart_initial();
          break;
        case "get_state":
          const response = {
            command: "get_state",
            state,
          };
          window.parent.postMessage(JSON.stringify(response), event.origin);
          break;
      }
    } catch (error) {
      console.error(`Invalid request: ${error}`);
      return;
    }
  }

  function main() {
    //todo set col_rel and config
    if (develop) {
      datasetUrl = "./data.csv";
      col_rel = {
        labels: "category",
        values: "Mon",
      };
      config = {
        chart: {
          fontSize: "16",
          fontWeight: "bold",
          color: "#5470c6",
          background: "#ffffff",
          internalRadius: "30",
          externalRadius: "60",
          borderRadius: "20",
          borderWidth: "5",
          borderColor: "#ffffff",
          type: " false",
        },
        title: {
          show: true,
          text: "Chart title",
          color: "#000",
          backgroundColor: "transparent",
          fontSize: "24",
          fontWeight: "normal",
          top: "0",
          left: "0",
          bottom: "0",
          right: "0",
        },
        legend: {
          show: true,
          align: "auto",
          itemGap: "10",
        },
        xAxis: {
          name: "xAxis",
          showName: true,
          fontSize: "14",
          nameLocation: "middle",
          position: "bottom",
          labelRotate: "0",
          nameGap: 24,
          margin: 8,
        },
        yAxis: {
          name: "yAxis",
          showName: true,
          fontSize: "12",
          position: "top",
          nameLocation: "middle",
          nameGap: 30,
          labelRotate: "0",
          margin: 8,
        },
        subtext: {
          text: "hi man sd",
          color: "#ffffff",
        },
        legend: {
          show: true,
          orient: "horizontal",
          align: "left",
          padding: "10",
          itemGap: "10",
        },
      };
      chart_initial();
    } else {
      state = "loaded";
      window.parent.document.getElementById("iframe0");
      window.addEventListener("message", onMessage, false);
      window.message = onMessage;
    }
  }

  window.onload = main;

  const chart_initial = async () => {
    waitUntil(() => {
      onWindowResize();
      if (
        width > 0 &&
        height > 0 &&
        Object.keys(col_rel).length &&
        Object.keys(config).length
      ) {
        chartDom = document.getElementById("chart-wrapper");
        chart = echarts.init(chartDom, null, { renderer: "svg" });
        init_chart();
        isChartInitialized = true;
        return true;
      }
    });
  };

  ///////////////////////////////////

  const get_options = () => {
    option = {
      color: [config.chart?.color],
      backgroundColor: "#2A0C4E",
      textStyle: {
        fontSize: `${config.chart?.fontSize}px`,
        fontWeight: config.chart?.fontWeight,
      },
      title: {
        show: config?.title?.show,
        text: config?.title?.text,
        textStyle: {
          color: config?.title?.color,
          fontSize: `${config?.title?.fontSize}px`,
          fontWeight: config?.title?.fontWeight,
        },
        top: config?.title?.top,
        left: config?.title?.left,
        bottom: config?.title?.bottom,
        right: config?.title?.right,
        backgroundColor: config?.title?.backgroundColor,
      },
      backgroundColor: config?.chart?.background,
      tooltip: {
        trigger: "axis",
        axisPointer: {
          type: "cross",
          label: {
            backgroundColor: "#6a7985",
          },
        },
      },
      legend: {
        show: config?.legend?.show,
        align: config?.legend?.align,
        itemGap: config?.legend?.itemGap,
        data: source[1],
      },
      toolbox: {
        feature: {
          // saveAsImage: {},
        },
      },
      xAxis: [
        {
          type: "category",
          boundaryGap: false,
          data: source[0].filter((item, index) => index > 0),
          position: config?.xAxis?.position,
          name: config?.xAxis?.showName && config?.xAxis?.name,
          nameLocation: config?.xAxis?.nameLocation,
          nameGap: config?.xAxis?.nameGap,
          axisLabel: {
            fontSize: `${config?.xAxis?.fontSize}px`,
            rotate: config?.xAxis?.labelRotate,
            margin: config?.xAxis?.margin,
          },
        },
      ],
      yAxis: [
        {
          type: "value",
          position: config?.yAxis?.position,
          name: config?.yAxis?.showName && config?.yAxis?.name,
          nameLocation: config?.yAxis?.nameLocation,
          nameGap: config?.yAxis?.nameGap,
          axisLabel: {
            fontSize: `${config?.yAxis?.fontSize}px`,
            rotate: config?.yAxis?.labelRotate,
            margin: config?.yAxis?.margin,
          },
        },
      ],
      series: [
        ...source.map((element, index) => {
          if (index > 0) {
            const title = element[0];
            const data = element.slice(1, element.length);
            return {
              name: title,
              type: "line",
              stack: "Total",
              areaStyle: {},
              emphasis: {
                focus: "series",
              },
              data: data,
            };
          }
        }),
      ],
    };
    return option;
  };

  // this method is executed when changing the config.
  const init_chart = () => {
    d3.csv(datasetUrl, function (data) {
      console.log("data in d3 : " + JSON.stringify(data));
      source = csvToRows(data);
      console.log("source : " + source);
      chart.setOption(get_options());
    });
    // todo init options
  };
  // this method is executed when changing the data binding.
  const change_col = (cols) => {
    init_chart();
  };

  // this method is executed when changing the config.
  const update_config_handler = (newConfig) => {
    let oldConfig = null;
    if (config) {
      oldConfig = { ...config };
    }
    config = newConfig;
    if (!chart) return;
    // todo update option
    // chart
    chart.setOption(get_options());
  };

  function csvToRows(data) {
    let result = Array();
    result.push([...Object.keys(data[0])]);
    data.forEach((element) => {
      result.push([...Object.values(element)]);
    });
    return result;
  }

  ///////////////////////   Helper Functions    ///////////////////////

  const waitUntil = (callback) => {
    const _t = setInterval(() => {
      const r = callback();
      if (r === true) {
        clearInterval(_t);
      }
    }, 100);
  };

  function downloadCsv(url) {
    return new Promise((resolve, reject) => {
      // todo
      if (develop) {
        Papa.parse(url, {
          download: true,
          complete(results, url) {
            resolve(results.data);
          },
          error(err, url) {
            reject(err);
          },
        });
      } else {
        Papa.parse(url, {
          download: true,
          complete(results, url) {
            resolve(results.data);
          },
          error(err, url) {
            reject(err);
          },
        });
      }
    });
  }

  function stringToBoll(_value) {
    if (_value === "true") {
      return true;
    } else {
      return false;
    }
  }
</script>
